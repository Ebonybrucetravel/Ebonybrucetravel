{
	"info": {
		"_postman_id": "ebony-bruce-travels-api-v2",
		"name": "Ebony Bruce Travels API",
		"description": "Complete API collection for Ebony Bruce Travels Booking System\n\n**Base URL:** `{{baseUrl}}/api/v1`\n\n**Authentication:** Most endpoints require JWT Bearer token. Get token from `/auth/login` or `/auth/register`.\n\n**Environment Variables:**\n- `baseUrl`: http://localhost:3001 (or your Railway URL)\n- `token`: JWT token (auto-set after login)\n- `offerRequestId`: Duffel offer request ID (auto-set after flight search)\n- `offerId`: Selected flight offer ID (auto-set after listing offers)\n- `nextCursor`: Pagination cursor for next page (auto-set)\n- `bookingId`: Booking ID (auto-set after creating booking)\n\n**New Features (v2.0):**\n- ‚úÖ Email verification on registration\n- ‚úÖ Password reset/forgot password flow\n- ‚úÖ Rate limiting (login: 5/min, register: 3/min)\n- ‚úÖ Delayed login notification emails (10-20 min security feature)\n- ‚úÖ Health check endpoints\n- ‚úÖ Request correlation IDs\n- ‚úÖ Audit logging for sensitive operations\n- ‚úÖ OAuth (Facebook/Google) with graceful fallback\n\n---\n\n## üìã API Sections\n\n### 1. Authentication\n- **Register User** - Create new account (sends verification email)\n- **Login** - Get JWT token (triggers delayed security notification)\n- **Forgot Password** - Request password reset email\n- **Reset Password** - Reset password with token\n- **Verify Email** - Verify email address with token\n- **Facebook OAuth** - Social login with Facebook\n- **Google OAuth** - Social login with Google\n\n### 2. User Profile\n- **Get My Profile** - Retrieve current user profile\n- **Update Profile** - Update profile information\n- **Upload Profile Image** - Upload profile picture to Cloudinary\n- **Change Password** - Change password (email/password accounts only)\n- **Delete Account** - Soft delete account\n\n### 3. Health Check\n- **Health Check** - Service health status\n- **Database Health** - Database connection status\n\n### 4. Flight Search & Offers\n- **Search Flights** - Get `offer_request_id` (Step 1 of two-step process)\n- **List Offers** - Get paginated flight offers using `offer_request_id` (Step 2)\n\n### 5. Bookings\n- **Create Booking** - Create a new booking (authenticated users)\n- **Create Guest Booking** - Create booking without account\n- **Get Booking** - Retrieve booking details by ID\n\n### 6. Payments\n- **Create Payment Intent** - Create Stripe payment intent for a booking\n- **Create Guest Payment Intent** - Create payment intent for guest booking\n- **Stripe Webhook** - Handle payment events\n\n---\n\n## üöÄ Quick Start Guide\n\n### Step 1: Authentication\n1. **Register** or **Login** to get JWT token\n2. Token is automatically saved to `{{token}}` environment variable\n3. **Verify Email** after registration (check email for verification link)\n4. **Login** triggers delayed security notification email (10-20 min)\n\n### Step 2: Flight Search (Two-Step Process)\n1. **Search Flights** ‚Üí Get `offer_request_id` (no auth required)\n   - Returns immediately (2-3 seconds)\n   - Cached for 10 minutes\n2. **List Offers** ‚Üí Get paginated flights using `offer_request_id`\n   - Returns 20 offers per page\n   - Markup automatically applied\n   - Use `nextCursor` for pagination\n\n### Step 3: Create Booking\n1. Select an offer from List Offers response\n2. **Create Booking** with offer details\n3. Booking ID is saved to `{{bookingId}}`\n\n### Step 4: Payment\n1. **Create Payment Intent** using booking ID\n2. Returns `clientSecret` for Stripe Checkout\n3. Webhook automatically updates booking status on payment\n\n### Step 5: Manage Profile\n1. **Get My Profile** to view current information\n2. **Update Profile** to change name, phone, dateOfBirth, gender\n3. **Upload Profile Image** to set profile picture\n4. **Change Password** if needed (email/password accounts only)\n\n---\n\n## üîí Security Features\n\n### Rate Limiting\n- **Login**: 5 requests per minute\n- **Register**: 3 requests per minute\n- **Forgot Password**: 3 requests per minute\n- **Reset Password**: 5 requests per minute\n- **Global**: 100 requests per minute (other endpoints)\n\n### Email Verification\n- New registrations receive verification email\n- Email must be verified (optional, but recommended)\n- Verification token expires in 24 hours\n\n### Password Reset\n- Forgot password sends reset email\n- Reset token expires in 1 hour\n- Security: Doesn't reveal if email exists\n\n### Login Notifications\n- Delayed email notification (10-20 minutes after login)\n- Includes IP address and device information\n- Link to change password if suspicious activity\n- Helps detect unauthorized access\n\n### Audit Logging\n- Password changes are logged\n- Account deletions are logged\n- Includes IP address and user agent\n- Stored in `audit_logs` table\n\n---\n\n## üîç Flight Search Flow (Why Two Requests?)\n\n**Step 1: Search** - Get `offer_request_id` (fast, 2-3 seconds)\n- Duffel searches airlines in background\n- Returns immediately with search ID\n- Cached for 10 minutes\n\n**Step 2: List Offers** - Use `offer_request_id` to get flights (fast, 1 second)\n- Paginated results (20 per page)\n- Markup applied automatically\n- Cached for 2 minutes\n\n**Benefits:**\n- ‚ö° Faster user experience (3-4 seconds vs 20+ seconds)\n- üìÑ Pagination (don't load 500 flights at once)\n- üíæ Caching (reuse searches, reduce costs)\n- üí∞ Cost-effective (fetch only what you need)\n\n---\n\n## üí≥ Payment Flow\n\n1. **Create Booking** ‚Üí Get `bookingId`\n2. **Create Payment Intent** ‚Üí Get `clientSecret`\n3. Use `clientSecret` with Stripe.js on frontend\n4. Stripe sends webhook events to `/payments/stripe/webhook`\n5. Booking status automatically updates:\n   - `payment_intent.succeeded` ‚Üí Booking status: `CONFIRMED`\n   - `payment_intent.payment_failed` ‚Üí Booking status: `FAILED`\n   - `charge.refunded` ‚Üí Booking status: `REFUNDED`\n\n---\n\n## üë§ User Profile Fields\n\n**Editable:**\n- `name` - Full name\n- `phone` - Phone number\n- `dateOfBirth` - Date of birth (YYYY-MM-DD format)\n- `gender` - Gender (Male, Female, Other, Prefer not to say)\n- `image` - Profile picture (via upload endpoint)\n\n**Read-only:**\n- `email` - Cannot be changed (security)\n- `emailVerified` - Email verification status\n- `role` - Set by system\n- `id` - Unique identifier\n\n---\n\n## üìù Testing Tips\n\n- Search endpoint returns `offer_request_id` (not offers)\n- Use List Offers endpoint to get actual flight options\n- Use `nextCursor` from response to paginate\n- Check `cached` field to see if result was from cache\n- All profile endpoints require authentication\n- Image upload accepts: jpg, jpeg, png, gif, webp (max 5MB)\n- Payment webhook requires Stripe webhook secret for signature verification\n- Rate limiting: If you get 429, wait a minute before retrying\n- Check health endpoint: `GET /api/v1/health` to verify service status\n- Correlation IDs: Check `X-Correlation-ID` header in responses for request tracking",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Authentication",
			"item": [
				{
					"name": "Register User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    if (response.token) {",
									"        pm.environment.set('token', response.token);",
									"        pm.environment.set('userId', response.user.id);",
									"        console.log('Token saved:', response.token);",
									"    }",
									"}",
									"",
									"pm.test('Status code is 201', function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('Response has user and token', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('user');",
									"    pm.expect(response).to.have.property('token');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"john.doe@example.com\",\n  \"name\": \"John Doe\",\n  \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/register",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"register"
							]
						},
						"description": "Register a new user account.\n\n**No authentication required.**\n\n**Rate Limit:** 3 requests per minute\n\n**Request Body:**\n- `email` (string, required): User email address\n- `name` (string, required): User full name\n- `password` (string, required): Password (min 6 characters)\n\n**Response:**\n- Returns user object and JWT token\n- Token is automatically saved to environment variable\n- **Verification email sent** - Check email for verification link\n- Email verification is optional but recommended\n\n**Email Verification:**\n- Verification email sent immediately after registration\n- Contains verification link with token\n- Token expires in 24 hours\n- Use `/auth/verify-email` endpoint to verify\n\n**Error Responses:**\n- `409 Conflict` - Email already exists\n- `429 Too Many Requests` - Rate limit exceeded (3/min)\n\n**Note:** After registration, you'll receive a welcome email with email verification link."
					},
					"response": []
				},
				{
					"name": "Login User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.token) {",
									"        pm.environment.set('token', response.token);",
									"        pm.environment.set('userId', response.user.id);",
									"        console.log('Token saved:', response.token);",
									"    }",
									"}",
									"",
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"john.doe@example.com\",\n  \"password\": \"password123\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/login",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"login"
							]
						},
						"description": "Login with email and password.\n\n**No authentication required.**\n\n**Rate Limit:** 5 requests per minute\n\n**Request Body:**\n- `email` (string, required): User email address\n- `password` (string, required): User password\n\n**Response:**\n- Returns user object and JWT token\n- Token is automatically saved to environment variable\n\n**Security Features:**\n- **Delayed Login Notification**: Email sent 10-20 minutes after login (random delay)\n- Notification includes IP address, device info, and login time\n- Link to change password if suspicious activity detected\n- Helps detect unauthorized access\n\n**Error Responses:**\n- `401 Unauthorized` - Invalid credentials\n- `401 Unauthorized` - Account deleted\n- `401 Unauthorized` - OAuth-only account (use social login)\n- `429 Too Many Requests` - Rate limit exceeded (5/min)\n\n**Note:**\n- OAuth users (Facebook/Google) cannot use email/password login\n- Deleted accounts cannot log in\n- Login notification email is sent asynchronously (doesn't delay login response)"
					},
					"response": []
				},
				{
					"name": "Facebook OAuth Login",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"console.log('üîµ Initiating Facebook OAuth login...');",
									"console.log('üí° Note: This will redirect to Facebook for authentication');",
									"console.log('üí° After authentication, you will be redirected to the callback URL');"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"// OAuth redirects to external provider, so we check for redirect",
									"if (pm.response.code === 302 || pm.response.code === 200) {",
									"    console.log('‚úÖ Facebook OAuth initiated');",
									"    console.log('üí° Follow the redirect to complete authentication');",
									"}",
									"",
									"pm.test('OAuth flow initiated', function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 302]);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/facebook",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"facebook"
							]
						},
						"description": "Initiate Facebook OAuth login.\n\n**No authentication required.**\n\n**How it works:**\n1. This endpoint redirects to Facebook for authentication\n2. User authorizes the app on Facebook\n3. Facebook redirects to `/auth/facebook/callback`\n4. Backend creates/updates user and generates JWT token\n5. User is redirected to frontend with token in query params\n\n**Frontend Integration:**\n- Redirect user to this endpoint: `GET /api/v1/auth/facebook`\n- Handle callback at `/auth/callback?token=...&user=...`\n- Extract token and user from query params\n- Store token and redirect to dashboard\n\n**Environment Variables Required:**\n- `FACEBOOK_APP_ID` - Facebook App ID\n- `FACEBOOK_APP_SECRET` - Facebook App Secret\n- `FACEBOOK_CALLBACK_URL` - Callback URL (default: `/api/v1/auth/facebook/callback`)\n- `FRONTEND_URL` - Frontend URL for redirect after auth (default: `http://localhost:3000`)\n\n**Graceful Handling:**\n- If OAuth credentials are not configured, endpoint returns error gracefully\n- Application continues to work without OAuth\n- Check logs for OAuth configuration status\n\n**Note:** In Postman, this will show a redirect. In a browser, it will redirect to Facebook."
					},
					"response": []
				},
				{
					"name": "Google OAuth Login",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"console.log('üî¥ Initiating Google OAuth login...');",
									"console.log('üí° Note: This will redirect to Google for authentication');",
									"console.log('üí° After authentication, you will be redirected to the callback URL');"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"// OAuth redirects to external provider, so we check for redirect",
									"if (pm.response.code === 302 || pm.response.code === 200) {",
									"    console.log('‚úÖ Google OAuth initiated');",
									"    console.log('üí° Follow the redirect to complete authentication');",
									"}",
									"",
									"pm.test('OAuth flow initiated', function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 302]);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/google",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"google"
							]
						},
						"description": "Initiate Google OAuth login.\n\n**No authentication required.**\n\n**How it works:**\n1. This endpoint redirects to Google for authentication\n2. User authorizes the app on Google\n3. Google redirects to `/auth/google/callback`\n4. Backend creates/updates user and generates JWT token\n5. User is redirected to frontend with token in query params\n\n**Frontend Integration:**\n- Redirect user to this endpoint: `GET /api/v1/auth/google`\n- Handle callback at `/auth/callback?token=...&user=...`\n- Extract token and user from query params\n- Store token and redirect to dashboard\n\n**Environment Variables Required:**\n- `GOOGLE_CLIENT_ID` - Google OAuth Client ID\n- `GOOGLE_CLIENT_SECRET` - Google OAuth Client Secret\n- `GOOGLE_CALLBACK_URL` - Callback URL (default: `/api/v1/auth/google/callback`)\n- `FRONTEND_URL` - Frontend URL for redirect after auth (default: `http://localhost:3000`)\n\n**Graceful Handling:**\n- If OAuth credentials are not configured, endpoint returns error gracefully\n- Application continues to work without OAuth\n- Check logs for OAuth configuration status\n\n**Note:** In Postman, this will show a redirect. In a browser, it will redirect to Google."
					},
					"response": []
				},
				{
					"name": "Forgot Password",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Password reset email sent', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('message');",
									"    console.log('‚úÖ Password reset email sent (if account exists)');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"user@example.com\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/forgot-password",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"forgot-password"
							]
						},
						"description": "Request password reset email.\n\n**No authentication required.**\n\n**Rate Limit:** 3 requests per minute\n\n**Request Body:**\n- `email` (string, required): User email address\n\n**Response:**\n- Always returns success (security best practice - doesn't reveal if email exists)\n- If account exists, password reset email is sent\n- Reset token expires in 1 hour\n\n**Security:**\n- Does not reveal if email exists (prevents email enumeration)\n- Reset link sent to email if account exists\n- OAuth-only accounts are silently ignored\n\n**Error Responses:**\n- `429 Too Many Requests` - Rate limit exceeded (3/min)\n\n**Note:** Check email for password reset link. The link expires in 1 hour."
					},
					"response": []
				},
				{
					"name": "Reset Password",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Password reset successful', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('message');",
									"    console.log('‚úÖ Password reset successfully');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"token\": \"reset-token-from-email\",\n  \"newPassword\": \"newSecurePassword123\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/reset-password",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"reset-password"
							]
						},
						"description": "Reset password with token from email.\n\n**No authentication required.**\n\n**Rate Limit:** 5 requests per minute\n\n**Request Body:**\n- `token` (string, required): Reset token from password reset email\n- `newPassword` (string, required): New password (min 6 characters)\n\n**Response:**\n- Returns success message\n- Password is updated\n- User can now login with new password\n\n**Error Responses:**\n- `400 Bad Request` - Invalid or expired token\n- `429 Too Many Requests` - Rate limit exceeded (5/min)\n\n**Note:**\n- Token expires in 1 hour\n- Token can only be used once\n- After reset, user must login with new password"
					},
					"response": []
				},
				{
					"name": "Verify Email",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Email verified successfully', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('message');",
									"    console.log('‚úÖ Email verified successfully');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"token\": \"verification-token-from-email\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/verify-email",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"verify-email"
							]
						},
						"description": "Verify email address with token from registration email.\n\n**No authentication required.**\n\n**Rate Limit:** 10 requests per minute\n\n**Request Body:**\n- `token` (string, required): Verification token from registration email\n\n**Response:**\n- Returns success message\n- Email is marked as verified\n- `emailVerified` field set to `true`\n\n**Error Responses:**\n- `400 Bad Request` - Invalid or expired token\n- `400 Bad Request` - Email already verified\n- `429 Too Many Requests` - Rate limit exceeded (10/min)\n\n**Note:**\n- Token expires in 24 hours\n- Token can only be used once\n- Email verification is optional but recommended\n- Verification link is sent in welcome email after registration"
					},
					"response": []
				}
			],
			"description": "Authentication endpoints for user registration, login, password reset, email verification, and OAuth (Facebook/Google).\n\n**OAuth Flow:**\n1. User clicks \"Login with Facebook/Google\" on frontend\n2. Frontend redirects to `/auth/facebook` or `/auth/google`\n3. Backend redirects to OAuth provider (Facebook/Google)\n4. User authorizes on OAuth provider\n5. OAuth provider redirects to callback endpoint\n6. Backend creates/updates user and generates JWT token\n7. Backend redirects to frontend with token: `{FRONTEND_URL}/auth/callback?token=...&user=...`\n8. Frontend extracts token and stores it (localStorage/sessionStorage)\n9. Frontend redirects user to dashboard\n\n**Account Linking:**\n- If user logs in with OAuth and email already exists, OAuth account is linked to existing email account\n- If user logs in with email/password and then uses OAuth with same email, accounts are automatically linked"
		},
		{
			"name": "User Profile",
			"item": [
				{
					"name": "Get My Profile",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Response has user profile', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('id');",
									"    pm.expect(response).to.have.property('email');",
									"    pm.expect(response).to.have.property('name');",
									"    pm.expect(response).to.have.property('role');",
									"    console.log('‚úÖ Profile retrieved:', response.email);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/users/me",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"users",
								"me"
							]
						},
						"description": "Get current user's profile information.\n\n**Authentication required.**\n\n**Response includes:**\n- id, email, name, phone\n- image (Cloudinary URL)\n- dateOfBirth, gender\n- role, timestamps"
					},
					"response": []
				},
				{
					"name": "Update Profile",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Profile updated successfully', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('id');",
									"    pm.expect(response).to.have.property('email');",
									"    console.log('‚úÖ Profile updated:', response.name || response.email);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"Seyi Obadeyi\",\n  \"phone\": \"+2348165000000\",\n  \"dateOfBirth\": \"1992-05-15\",\n  \"gender\": \"Male\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/users/me",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"users",
								"me"
							]
						},
						"description": "Update user profile information.\n\n**Authentication required.**\n\n**Editable fields:**\n- `name` - Full name\n- `phone` - Phone number\n- `dateOfBirth` - Date of birth (YYYY-MM-DD format)\n- `gender` - Gender (Male, Female, Other, Prefer not to say)\n\n**Note:** Email cannot be changed (security)."
					},
					"response": []
				},
				{
					"name": "Upload Profile Image",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Image uploaded successfully', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('image');",
									"    if (response.image) {",
									"        console.log('‚úÖ Image uploaded:', response.image);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "PUT",
						"header": [],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "image",
									"type": "file",
									"src": [],
									"description": "Profile image file (jpg, jpeg, png, gif, webp). Max 5MB. Auto-resized to 400x400px."
								}
							]
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/users/me/avatar",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"users",
								"me",
								"avatar"
							]
						},
						"description": "Upload or update user profile image.\n\n**Authentication required.**\n\n**Requirements:**\n- File format: jpg, jpeg, png, gif, webp\n- Max file size: 5MB\n- Auto-resized to 400x400px\n- Stored in Cloudinary\n- Old image automatically deleted when updating\n\n**Field name:** `image` (multipart/form-data)"
					},
					"response": []
				},
				{
					"name": "Change Password",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Password changed successfully', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('message');",
									"    console.log('‚úÖ Password changed successfully');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "PATCH",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"currentPassword\": \"oldPassword123\",\n  \"newPassword\": \"newPassword123\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/users/me/password",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"users",
								"me",
								"password"
							]
						},
						"description": "Change user password.\n\n**Authentication required.**\n\n**Request Body:**\n- `currentPassword` (string, required): Current password\n- `newPassword` (string, required): New password (minimum 6 characters)\n\n**Security:**\n- Current password is verified before allowing change\n- Password change is logged to audit table\n- Includes IP address and user agent in audit log\n\n**Error Responses:**\n- `400 Bad Request` - Invalid current password or OAuth account (cannot change password for social login accounts)\n- `401 Unauthorized` - Current password is incorrect\n- `404 Not Found` - User not found\n\n**Note:** OAuth users (Facebook/Google) cannot change password. They must use social login."
					},
					"response": []
				},
				{
					"name": "Delete Account",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Account deleted successfully', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('message');",
									"    console.log('‚úÖ Account deleted successfully');",
									"    console.log('‚ö†Ô∏è  Note: This is a soft delete. Account data is preserved but marked as deleted.');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/users/me",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"users",
								"me"
							]
						},
						"description": "Delete user account (soft delete).\n\n**Authentication required.**\n\n**What happens:**\n- Account is soft deleted (marked as deleted, not permanently removed)\n- Email is anonymized to ensure uniqueness\n- Profile image is deleted from Cloudinary\n- User cannot log in after deletion\n\n**Restrictions:**\n- Cannot delete account with active bookings (PENDING, PAYMENT_PENDING, CONFIRMED)\n- Must cancel or complete all bookings first\n\n**Error Responses:**\n- `400 Bad Request` - Account has active bookings\n\n**Note:** This is a soft delete. Account data is preserved for audit purposes but the user cannot log in."
					},
					"response": []
				}
			],
			"description": "User profile management endpoints.\n\n**All endpoints require authentication.**\n\n**Features:**\n- Get profile information\n- Update profile (name, phone, date of birth, gender)\n- Upload profile image to Cloudinary\n- Change password (email/password accounts only)\n- Delete account (soft delete)\n\n**Security & Audit:**\n- Password changes are logged to audit table\n- Account deletions are logged to audit table\n- Includes IP address and user agent in audit logs\n\n**Note:** Email cannot be changed (security requirement). OAuth users cannot change password."
		},
		{
			"name": "Health Check",
			"item": [
				{
					"name": "Health Check",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Service is healthy', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('status', 'ok');",
									"    pm.expect(response).to.have.property('uptime');",
									"    console.log('‚úÖ Service is healthy');",
									"    console.log('Uptime:', response.uptime, 'seconds');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/health",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"health"
							]
						},
						"description": "Check service health status.\n\n**No authentication required.**\n\n**Response:**\n- `status`: Service status (\"ok\" or \"error\")\n- `timestamp`: Current timestamp\n- `uptime`: Service uptime in seconds\n- `environment`: Current environment (development/production)\n\n**Use Cases:**\n- Load balancer health checks\n- Monitoring and alerting\n- Service status verification\n\n**Note:** This endpoint is public and doesn't require authentication."
					},
					"response": []
				},
				{
					"name": "Database Health Check",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Database status', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('status');",
									"    pm.expect(response).to.have.property('database');",
									"    if (response.database === 'connected') {",
									"        console.log('‚úÖ Database is connected');",
									"    } else {",
									"        console.log('‚ùå Database is disconnected');",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/health/db",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"health",
								"db"
							]
						},
						"description": "Check database connection health.\n\n**No authentication required.**\n\n**Response:**\n- `status`: Health status (\"ok\" or \"error\")\n- `database`: Database connection status (\"connected\" or \"disconnected\")\n- `timestamp`: Current timestamp\n- `error`: Error message (only in production if connection fails)\n\n**Use Cases:**\n- Database monitoring\n- Connection pool health checks\n- Troubleshooting database issues\n\n**Note:**\n- Returns 200 even if database is disconnected (for monitoring)\n- Check `database` field to determine actual status\n- Error details hidden in production for security"
					},
					"response": []
				}
			],
			"description": "Health check endpoints for monitoring service and database status.\n\n**No authentication required.**\n\n**Endpoints:**\n- **Health Check** - General service health\n- **Database Health** - Database connection status\n\n**Use Cases:**\n- Load balancer health checks\n- Monitoring dashboards\n- Alerting systems\n- Service status verification"
		},
		{
			"name": "Flight Search",
			"item": [
				{
					"name": "Search Flights - Get Offer Request ID",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Response has offer_request_id', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response.data).to.have.property('offer_request_id');",
									"    ",
									"    // Save offer_request_id for pagination",
									"    if (response.data.offer_request_id) {",
									"        pm.environment.set('offerRequestId', response.data.offer_request_id);",
									"        console.log('Offer Request ID saved:', response.data.offer_request_id);",
									"        console.log('Cached:', response.data.cached || false);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"origin\": \"LHR\",\n  \"destination\": \"JFK\",\n  \"departureDate\": \"2026-01-25\",\n  \"passengers\": 1,\n  \"cabinClass\": \"economy\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/search/flights",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"search",
								"flights"
							]
						},
						"description": "**STEP 1: Search for flights and get offer_request_id**\n\n**No authentication required.**\n\n**What This Does:**\n- Creates a flight search request with Duffel API\n- Returns immediately with `offer_request_id` (2-3 seconds)\n- Duffel continues searching airlines in background\n- Does NOT return flight offers (use Step 2 for that)\n\n**Why Two Steps?**\n- Faster response (don't wait 20+ seconds for all airlines)\n- Enables pagination (can't show 500 flights at once)\n- Allows caching (reuse searches, reduce costs)\n\n**Caching:**\n- Search results cached for 10 minutes\n- Same search parameters = cached `offer_request_id` (no API call)\n- Check `cached: true` in response to see if from cache\n\n**Request Body:**\n- `origin` (string, required): Origin airport IATA code (e.g., \"LHR\", \"LOS\", \"JFK\")\n- `destination` (string, required): Destination airport IATA code\n- `departureDate` (string, required): ISO 8601 date (YYYY-MM-DD)\n- `returnDate` (string, optional): For round trips (YYYY-MM-DD)\n- `passengers` (number, required): Number of passengers (min: 1)\n- `cabinClass` (string, optional): economy, premium_economy, business, first (default: economy)\n- `maxConnections` (number, optional): Max connections (0 = direct only, default: 1)\n- `passengerDetails` (array, optional): Detailed passenger info (age, type, etc.)\n\n**Response Structure:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"offer_request_id\": \"orq_0000B2dmFMfv0fyigjlHNI\",\n    \"live_mode\": false,\n    \"cached\": false,\n    \"message\": \"Use /bookings/offers endpoint to paginate offers\"\n  },\n  \"message\": \"Flight search completed...\"\n}\n```\n\n**Next Step:**\nUse the `offer_request_id` with **List Offers** endpoint to get actual flight options.\n\n**Example Scenarios:**\n- One-way: Only `departureDate`\n- Round trip: Both `departureDate` and `returnDate`\n- Direct flights: `maxConnections: 0`\n- Business class: `cabinClass: \"business\"`"
					},
					"response": []
				},
				{
					"name": "List Offers - First Page",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Ensure offerRequestId is set",
									"const offerRequestId = pm.environment.get('offerRequestId');",
									"if (!offerRequestId) {",
									"    console.error('‚ùå No offerRequestId found!');",
									"    console.warn('‚ö†Ô∏è  Please run \"Search Flights - Get Offer Request ID\" first.');",
									"} else {",
									"    console.log('‚úÖ Using offerRequestId:', offerRequestId);",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Response has paginated offers', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response).to.have.property('data');",
									"    pm.expect(response).to.have.property('meta');",
									"    pm.expect(response.data).to.be.an('array');",
									"    pm.expect(response.meta).to.have.property('nextCursor');",
									"    pm.expect(response.meta).to.have.property('hasMore');",
									"    ",
									"    // Save first offer ID if available",
									"    if (response.data && response.data.length > 0) {",
									"        pm.environment.set('offerId', response.data[0].id);",
									"        pm.environment.set('offerPrice', response.data[0].final_amount);",
									"        pm.environment.set('offerCurrency', response.data[0].currency);",
									"        console.log('‚úÖ Found', response.data.length, 'offers');",
									"        console.log('üìÑ Has more:', response.meta.hasMore);",
									"        console.log('‚û°Ô∏è  Next cursor:', response.meta.nextCursor || 'none');",
									"        console.log('üí∞ First offer price:', response.data[0].final_amount, response.data[0].currency);",
									"        console.log('üìä Markup:', response.data[0].markup_percentage + '%');",
									"    } else {",
									"        console.warn('‚ö†Ô∏è  No offers found. Try a different search.');",
									"    }",
									"    ",
									"    // Save next cursor for pagination",
									"    if (response.meta && response.meta.nextCursor) {",
									"        pm.environment.set('nextCursor', response.meta.nextCursor);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/offers?offer_request_id={{offerRequestId}}&limit=20&sort=total_amount&sortOrder=asc",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"offers"
							],
							"query": [
								{
									"key": "offer_request_id",
									"value": "{{offerRequestId}}",
									"description": "Offer request ID from search endpoint"
								},
								{
									"key": "limit",
									"value": "20",
									"description": "Items per page (1-200)",
									"disabled": false
								},
								{
									"key": "sort",
									"value": "total_amount",
									"description": "Sort field",
									"disabled": true
								},
								{
									"key": "sortOrder",
									"value": "asc",
									"description": "Sort order (asc/desc)",
									"disabled": true
								}
							]
						},
						"description": "**STEP 2: Get paginated flight offers**\n\n**No authentication required.**\n\n**What This Does:**\n- Fetches flight offers for a given `offer_request_id`\n- Returns paginated results (default: 20 per page)\n- Applies markup automatically (adds your profit margin)\n- Fast response (1 second)\n\n**Prerequisites:**\n- Must have `offer_request_id` from Step 1 (Search Flights)\n- Automatically saved to environment after search\n\n**Caching:**\n- Offers cached for 2 minutes\n- Same pagination params = cached results (no API call)\n- Prices change frequently, so short cache time\n\n**Query Parameters:**\n- `offer_request_id` (required): From search endpoint (auto-filled from environment)\n- `limit` (optional): Items per page (1-200, default: 20)\n- `cursor` (optional): For next/previous pages (from `meta.nextCursor`)\n- `sort` (optional): Sort field - `total_amount`, `total_duration`, `departure_time`\n- `sortOrder` (optional): `asc` (lowest first) or `desc` (highest first)\n\n**Response Structure:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    {\n      \"id\": \"off_123\",\n      \"original_amount\": \"500.00\",\n      \"markup_percentage\": 10,\n      \"markup_amount\": \"50.00\",\n      \"final_amount\": \"550.00\",\n      \"currency\": \"USD\",\n      \"slices\": [...],\n      \"segments\": [...],\n      \"expires_at\": \"2026-01-25T10:00:00Z\"\n    }\n  ],\n  \"meta\": {\n    \"count\": 20,\n    \"total\": 20,\n    \"limit\": 20,\n    \"nextCursor\": \"g2wAAAACbQAAABBBZXJvbWlzdC1LaGFya2l2bQAAAB=\",\n    \"prevCursor\": null,\n    \"hasMore\": true,\n    \"page\": 1,\n    \"totalPages\": 2\n  }\n}\n```\n\n**Pagination:**\n- Use `meta.nextCursor` for next page\n- Use `meta.prevCursor` for previous page\n- Check `meta.hasMore` to see if more pages available\n- Use \"List Offers - Next Page\" request with cursor\n\n**Markup Applied:**\n- `original_amount`: Price from airline\n- `markup_percentage`: Your profit margin\n- `markup_amount`: Profit in currency\n- `final_amount`: Price customer pays (original + markup)\n\n**Important:**\n- Offers expire (check `expires_at`)\n- Use offer `id` to create booking\n- Sort by price: `sort=total_amount&sortOrder=asc`"
					},
					"response": []
				},
				{
					"name": "List Offers - Next Page",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Get cursor from previous response or environment",
									"const cursor = pm.environment.get('nextCursor');",
									"const offerRequestId = pm.environment.get('offerRequestId');",
									"",
									"if (!offerRequestId) {",
									"    console.error('‚ùå No offerRequestId found!');",
									"    console.warn('‚ö†Ô∏è  Please run \"Search Flights\" first.');",
									"}",
									"",
									"if (!cursor) {",
									"    console.warn('‚ö†Ô∏è  No cursor found. Getting first page instead.');",
									"    console.info('üí° Tip: Run \"List Offers - First Page\" first to get cursor.');",
									"} else {",
									"    console.log('‚úÖ Using cursor for next page:', cursor);",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Response has next page data', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('success', true);",
									"    pm.expect(response.meta).to.have.property('nextCursor');",
									"    ",
									"    // Save next cursor for subsequent pages",
									"    if (response.meta && response.meta.nextCursor) {",
									"        pm.environment.set('nextCursor', response.meta.nextCursor);",
									"        console.log('‚úÖ Next cursor saved:', response.meta.nextCursor);",
									"    } else {",
									"        console.log('‚ÑπÔ∏è  No more pages available');",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/offers?offer_request_id={{offerRequestId}}&limit=20&cursor={{nextCursor}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"offers"
							],
							"query": [
								{
									"key": "offer_request_id",
									"value": "{{offerRequestId}}"
								},
								{
									"key": "limit",
									"value": "20"
								},
								{
									"key": "cursor",
									"value": "{{nextCursor}}",
									"description": "Cursor from previous response meta.nextCursor"
								}
							]
						},
						"description": "**Get next page of offers using pagination cursor**\n\n**No authentication required.**\n\n**What This Does:**\n- Fetches the next page of offers using cursor from previous response\n- Automatically uses `nextCursor` from environment (set by previous request)\n\n**How It Works:**\n1. Call \"List Offers - First Page\" (no cursor)\n2. Response includes `meta.nextCursor`\n3. Call this endpoint (cursor auto-filled)\n4. Repeat until `meta.hasMore` is `false`\n\n**Query Parameters:**\n- `offer_request_id` (required): From search endpoint\n- `limit` (optional): Items per page (default: 20)\n- `cursor` (required): From `meta.nextCursor` of previous response (auto-filled)\n\n**Response:**\n- Same structure as first page\n- New `meta.nextCursor` for next page\n- `meta.hasMore` indicates if more pages\n\n**Example Flow:**\n```\nPage 1: ?offer_request_id=orq_123&limit=20\n  ‚Üí nextCursor: \"abc\"\n\nPage 2: ?offer_request_id=orq_123&limit=20&cursor=abc\n  ‚Üí nextCursor: \"def\"\n\nPage 3: ?offer_request_id=orq_123&limit=20&cursor=def\n  ‚Üí hasMore: false (no more pages)\n```"
					},
					"response": []
				},
				{
					"name": "List Offers - Sort by Price (Low to High)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/offers?offer_request_id={{offerRequestId}}&limit=20&sort=total_amount&sortOrder=asc",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"offers"
							],
							"query": [
								{
									"key": "offer_request_id",
									"value": "{{offerRequestId}}"
								},
								{
									"key": "limit",
									"value": "20"
								},
								{
									"key": "sort",
									"value": "total_amount"
								},
								{
									"key": "sortOrder",
									"value": "asc"
								}
							]
						},
						"description": "Get offers sorted by price (lowest first)."
					},
					"response": []
				},
				{
					"name": "List Offers - Sort by Duration (Shortest First)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/offers?offer_request_id={{offerRequestId}}&limit=20&sort=total_duration&sortOrder=asc",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"offers"
							],
							"query": [
								{
									"key": "offer_request_id",
									"value": "{{offerRequestId}}"
								},
								{
									"key": "limit",
									"value": "20"
								},
								{
									"key": "sort",
									"value": "total_duration"
								},
								{
									"key": "sortOrder",
									"value": "asc"
								}
							]
						},
						"description": "Get offers sorted by flight duration (shortest first)."
					},
					"response": []
				}
			],
			"description": "**Flight Search & Offers - Two-Step Process**\n\n**Complete Workflow:**\n1. **Search Flights** ‚Üí Get `offer_request_id` (2-3 seconds)\n   - Creates search request with Duffel\n   - Returns immediately with search ID\n   - Duffel searches airlines in background\n\n2. **List Offers** ‚Üí Get paginated flights (1 second)\n   - Use `offer_request_id` from step 1\n   - Get 20 flights per page (default)\n   - Markup automatically applied\n   - Use cursor to paginate\n\n3. **Create Booking** ‚Üí Use offer `id` from step 2\n   - Select an offer from results\n   - Use offer `id` to create booking\n\n**Why Two Requests?**\n- ‚ö° **Faster**: User sees results in 3-4 seconds (vs 20+ seconds)\n- üìÑ **Pagination**: Can't show 500 flights at once\n- üíæ **Caching**: Reuse searches, reduce API costs\n- üí∞ **Cost-effective**: Fetch only what you need\n\n**Caching Benefits:**\n- Search results cached 10 minutes\n- Offers cached 2 minutes\n- Reduces API costs by 80-90%\n- Faster response times\n- Multiple users can share same search\n\n**Important Notes:**\n- Search endpoint does NOT return offers (only ID)\n- Must use List Offers endpoint to get flights\n- Offers expire (check `expires_at` field)\n- Use `offer_request_id` for all pagination requests"
		},
		{
			"name": "Bookings",
			"item": [
				{
					"name": "Create Booking (Authenticated)",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"if (!pm.environment.get('token')) {",
									"    console.warn('No token found. Please login first.');",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 201', function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    if (response.data.reference) {",
									"        pm.environment.set('bookingReference', response.data.reference);",
									"        pm.environment.set('bookingId', response.data.id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"productType\": \"FLIGHT_INTERNATIONAL\",\n  \"provider\": \"DUFFEL\",\n  \"basePrice\": 45000,\n  \"currency\": \"GBP\",\n  \"bookingData\": {\n    \"offerId\": \"{{offerId}}\",\n    \"origin\": \"LHR\",\n    \"destination\": \"JFK\",\n    \"departureDate\": \"2026-01-25\",\n    \"airline\": \"British Airways\"\n  },\n  \"passengerInfo\": {\n    \"firstName\": \"John\",\n    \"lastName\": \"Doe\",\n    \"email\": \"john.doe@example.com\",\n    \"phone\": \"+1234567890\"\n  }\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings"
							]
						},
						"description": "Create a booking for an authenticated user.\n\n**Authentication required:** JWT Bearer token\n\n**Uses offer ID from flight search results.**"
					},
					"response": []
				},
				{
					"name": "Create Guest Booking",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"productType\": \"FLIGHT_INTERNATIONAL\",\n  \"provider\": \"DUFFEL\",\n  \"basePrice\": 45000,\n  \"currency\": \"GBP\",\n  \"bookingData\": {\n    \"offerId\": \"{{offerId}}\",\n    \"origin\": \"LHR\",\n    \"destination\": \"JFK\"\n  },\n  \"passengerInfo\": {\n    \"firstName\": \"Jane\",\n    \"lastName\": \"Smith\",\n    \"email\": \"jane.smith@example.com\",\n    \"phone\": \"+1234567890\"\n  }\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/guest",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"guest"
							]
						},
						"description": "Create a booking without authentication (guest checkout)."
					},
					"response": []
				},
				{
					"name": "List Bookings",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings"
							]
						},
						"description": "Get list of bookings.\n\n**Authentication required.**\n- CUSTOMER: Sees only their bookings\n- ADMIN: Sees all bookings"
					},
					"response": []
				},
				{
					"name": "Get Booking by ID",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/{{bookingId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"{{bookingId}}"
							]
						},
						"description": "Get booking details by ID."
					},
					"response": []
				},
				{
					"name": "Cancel Duffel Flight Booking",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"if (!pm.environment.get('token')) {",
									"    console.warn('‚ö†Ô∏è  No token found. Please login first.');",
									"}",
									"",
									"if (!pm.environment.get('bookingId')) {",
									"    console.warn('‚ö†Ô∏è  No bookingId found. Please create a booking first.');",
									"} else {",
									"    console.log('‚úÖ Cancelling booking:', pm.environment.get('bookingId'));",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
							"exec": [
								"pm.test('Status code is 200 or 403', function () {",
								"    pm.expect(pm.response.code).to.be.oneOf([200, 403, 400]);",
								"});",
								"",
								"if (pm.response.code === 403) {",
								"    console.error('‚ùå Access denied. Only administrators can cancel bookings.');",
								"    console.log('üí° Tip: Use an admin account token');",
								"} else if (pm.response.code === 400) {",
								"    const response = pm.response.json();",
								"    console.error('‚ùå Cancellation not allowed:', response.message || response.error);",
								"    console.log('üí° Possible reasons:');",
								"    console.log('   - Within 24 hours of departure');",
								"    console.log('   - Non-refundable fare');",
								"    console.log('   - Departure time has passed');",
								"} else if (pm.response.code === 200) {",
								"    const response = pm.response.json();",
								"    console.log('‚úÖ Booking cancelled successfully');",
								"    if (response.data.cancellationId) {",
								"        pm.environment.set('cancellationId', response.data.cancellationId);",
								"        console.log('üìã Cancellation ID:', response.data.cancellationId);",
								"    }",
								"    if (response.data.refundAmount) {",
								"        console.log('üí∞ Refund amount:', response.data.refundAmount, response.data.refundTo || '');",
								"    }",
								"    if (response.data.hasAirlineCredits) {",
								"        console.log('üé´ Airline credits issued (no cash refund)');",
								"    }",
								"}"
							],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/{{bookingId}}/cancel",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"{{bookingId}}",
								"cancel"
							]
						},
						"description": "Cancel a Duffel flight booking (ADMIN ONLY).\n\n**‚ö†Ô∏è RESTRICTIONS:**\n- **Admin Only:** Only administrators (ADMIN, SUPER_ADMIN) can cancel bookings\n- **Time Restriction:** Cancellations are NOT allowed within 24 hours of departure\n- **Non-Refundable Fares:** Cancellations are blocked for non-refundable fares\n- **After Departure:** Cannot cancel after departure time has passed\n\n**Authentication required:** JWT Bearer token (Admin role)\n\n**Requirements:**\n- Booking must be a Duffel flight booking (`provider: DUFFEL`)\n- Booking must be in `CONFIRMED` status\n- User must have ADMIN or SUPER_ADMIN role\n- Departure must be more than 24 hours away\n- Fare must allow refunds (non-refundable fares blocked)\n\n**Process:**\n1. Validates cancellation restrictions (time, fare type)\n2. Creates pending cancellation in Duffel\n3. Confirms cancellation\n4. Updates booking status to `CANCELLED`\n5. Processes refund if applicable\n6. Sends cancellation email to customer\n\n**Response includes:**\n- `cancellationId` - Duffel cancellation ID\n- `refundAmount` - Refund amount (if applicable)\n- `refundTo` - Where refund goes (balance, airline_credits, card)\n- `hasAirlineCredits` - Whether airline issued credits instead of cash\n- `airlineCredits` - Credit details (if applicable)\n\n**Error Responses:**\n- `403 Forbidden` - User is not an administrator\n- `400 Bad Request` - Cancellation not allowed (time restriction or non-refundable fare)\n\n**Note:** Customers cannot cancel directly. They must contact support for cancellations."
					},
					"response": []
				},
				{
					"name": "Duffel Webhook (Test)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"type\": \"order.created\",\n  \"object\": {\n    \"id\": \"ord_0000A3tQcEcrfuFAb0RQPH\",\n    \"booking_reference\": \"ABC123\",\n    \"status\": \"confirmed\"\n  },\n  \"created_at\": \"2026-01-25T20:00:00Z\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/bookings/duffel/webhook",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"bookings",
								"duffel",
								"webhook"
							]
						},
						"description": "Duffel webhook endpoint for order updates.\n\n**‚ö†Ô∏è IMPORTANT:** This endpoint is called by Duffel, not by your application.\n\n**Configuration:**\n1. Go to Duffel Dashboard ‚Üí Webhooks\n2. Add endpoint: `https://your-domain.com/api/v1/bookings/duffel/webhook`\n3. Select events:\n   - `order.created` - Order successfully created\n   - `order.creation_failed` - Order creation failed\n   - `order.updated` - Order details updated\n   - `order.airline_initiated_change` - Airline changed the booking\n   - `order_cancellation.created` - Cancellation initiated\n   - `order_cancellation.confirmed` - Cancellation confirmed\n\n**Events Handled:**\n- `order.created` ‚Üí Updates booking with order details\n- `order.creation_failed` ‚Üí Marks booking as failed\n- `order.updated` ‚Üí Updates booking with latest order data\n- `order.airline_initiated_change` ‚Üí Stores change information\n- `order_cancellation.created` ‚Üí Stores cancellation details\n- `order_cancellation.confirmed` ‚Üí Updates booking to cancelled, processes refund\n\n**Note:** This request is for testing only. In production, Duffel calls this endpoint automatically.\n\n**Test Payload Example:**\n```json\n{\n  \"type\": \"order.created\",\n  \"object\": {\n    \"id\": \"ord_0000A3tQcEcrfuFAb0RQPH\",\n    \"booking_reference\": \"ABC123\",\n    \"status\": \"confirmed\"\n  },\n  \"created_at\": \"2026-01-25T20:00:00Z\"\n}\n```"
					},
					"response": []
				}
			],
			"description": "Booking management endpoints.\n\n**All endpoints require authentication (except webhook).**\n\n**Endpoints:**\n- Create Booking (Authenticated) - Create booking for logged-in user\n- Create Guest Booking - Create booking without account\n- Get Booking - Retrieve booking details by ID\n- Cancel Duffel Flight Booking - Cancel a confirmed Duffel flight booking\n- Duffel Webhook - Handle order updates from Duffel (no auth required)\n\n**Complete Booking Flow:**\n1. Search flights and get offers\n2. Select an offer\n3. Create booking with offer details\n4. Get booking ID\n5. Create payment intent using booking ID\n6. Payment succeeds ‚Üí Duffel order created automatically\n7. Duffel webhook updates booking with order details\n8. Cancel booking if needed (Duffel order cancelled automatically)\n\n**Order Creation:**\n- Duffel orders are created automatically when payment succeeds\n- No manual order creation needed\n- Order ID stored in `providerBookingId`\n- Full order data stored in `providerData`\n\n**Cancellation:**\n- Only Duffel flight bookings can be cancelled via this endpoint\n- Cancellation is immediate\n- Refunds processed automatically if applicable\n- Booking status updated to `CANCELLED`"
		},
		{
			"name": "Payments",
			"item": [
				{
					"name": "Create Payment Intent",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"if (!pm.environment.get('token')) {",
									"    console.warn('‚ö†Ô∏è  No token found. Please login first.');",
									"}",
									"",
									"if (!pm.environment.get('bookingId')) {",
									"    console.warn('‚ö†Ô∏è  No bookingId found. Please create a booking first.');",
									"    console.log('üí° Tip: Use \"Create Booking\" endpoint to get bookingId');",
									"} else {",
									"    console.log('‚úÖ Using bookingId:', pm.environment.get('bookingId'));",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200 or 201', function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
									"});",
									"",
									"pm.test('Response has clientSecret', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('clientSecret');",
									"    pm.expect(response).to.have.property('paymentIntentId');",
									"    ",
									"    console.log('‚úÖ Payment intent created');",
									"    console.log('üí≥ Payment Intent ID:', response.paymentIntentId);",
									"    console.log('üîë Client Secret:', response.clientSecret.substring(0, 20) + '...');",
									"    console.log('üí° Use clientSecret with Stripe.js on frontend');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"bookingId\": \"{{bookingId}}\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/payments/stripe/create-intent",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"payments",
								"stripe",
								"create-intent"
							]
						},
						"description": "Create a Stripe payment intent for a booking (authenticated user).\n\n**Authentication required.**\n\n**Prerequisites:**\n- Must have a booking ID (from Create Booking endpoint)\n- Booking must be in PENDING or PAYMENT_PENDING status\n- User must own the booking (or be ADMIN/SUPER_ADMIN)\n\n**Request:**\n```json\n{\n  \"bookingId\": \"clx1234567890\"\n}\n```\n\n**Response:**\n```json\n{\n  \"clientSecret\": \"pi_xxx_secret_xxx\",\n  \"paymentIntentId\": \"pi_xxx\"\n}\n```\n\n**Next Steps:**\n1. Use `clientSecret` with Stripe.js on frontend\n2. Stripe handles payment processing\n3. Webhook automatically updates booking status:\n   - `payment_intent.succeeded` ‚Üí Booking: `CONFIRMED`\n   - `payment_intent.payment_failed` ‚Üí Booking: `FAILED`\n   - `charge.refunded` ‚Üí Booking: `REFUNDED`\n\n**Note:** Webhook endpoint is `/api/v1/payments/stripe/webhook` (configured in Stripe Dashboard)"
					},
					"response": []
				},
				{
					"name": "Create Guest Payment Intent",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"bookingReference\": \"EBT-20260126-123456\",\n  \"email\": \"guest@example.com\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/payments/stripe/create-intent/guest",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"payments",
								"stripe",
								"create-intent",
								"guest"
							]
						},
						"description": "Create a Stripe payment intent for a **guest booking**.\n\n**Authentication:** Not required (public endpoint) ‚úÖ\n\n**Security:**\n- Uses **booking reference** + **passenger email** to securely identify the booking\n- Common industry pattern for guest checkout (similar to PNR + last name)\n\n**Prerequisites:**\n- Guest booking must exist (from `Create Guest Booking` endpoint)\n- Booking must be in PENDING or PAYMENT_PENDING status\n- Email must match passenger or user email on the booking\n\n**Request:**\n```json\n{\n  \"bookingReference\": \"EBT-20260126-123456\",\n  \"email\": \"guest@example.com\"\n}\n```\n\n**Response:**\n```json\n{\n  \"clientSecret\": \"pi_xxx_secret_xxx\",\n  \"paymentIntentId\": \"pi_xxx\"\n}\n```\n\n**Next Steps:**\n1. Use `clientSecret` with Stripe.js on frontend\n2. Stripe handles payment processing\n3. Webhook automatically updates booking status\n\n**Note:** This flow is designed for guest checkout (no login required)."
					},
					"response": []
				},
				{
					"name": "Stripe Webhook (Test)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Webhook received', function () {",
									"    const response = pm.response.json();",
									"    pm.expect(response).to.have.property('received', true);",
									"    console.log('‚úÖ Webhook event processed');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "stripe-signature",
								"value": "t=1234567890,v1=signature_here",
								"description": "Stripe webhook signature (automatically added by Stripe)"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"id\": \"evt_xxx\",\n  \"type\": \"payment_intent.succeeded\",\n  \"data\": {\n    \"object\": {\n      \"id\": \"pi_xxx\",\n      \"metadata\": {\n        \"bookingId\": \"{{bookingId}}\"\n      }\n    }\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/payments/stripe/webhook",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"payments",
								"stripe",
								"webhook"
							]
						},
						"description": "Stripe webhook endpoint for payment events.\n\n**‚ö†Ô∏è IMPORTANT:** This endpoint is called by Stripe, not by your application.\n\n**Configuration:**\n1. Go to Stripe Dashboard ‚Üí Webhooks\n2. Add endpoint: `https://your-domain.com/api/v1/payments/stripe/webhook`\n3. Select events:\n   - `payment_intent.succeeded`\n   - `payment_intent.payment_failed`\n   - `payment_intent.canceled`\n   - `charge.refunded`\n4. Copy webhook signing secret (starts with `whsec_...`)\n5. Add to `.env`: `STRIPE_WEBHOOK_SECRET=\"whsec_...\"`\n\n**Security:**\n- Webhook signature is verified automatically\n- Only legitimate Stripe events are processed\n- Invalid signatures are rejected\n\n**Events Handled:**\n- `payment_intent.succeeded` ‚Üí Updates booking to `CONFIRMED`\n- `payment_intent.payment_failed` ‚Üí Updates booking to `FAILED`\n- `payment_intent.canceled` ‚Üí Updates booking to `CANCELLED`\n- `charge.refunded` ‚Üí Updates booking to `REFUNDED`\n\n**Note:** This request is for testing only. In production, Stripe calls this endpoint automatically."
					},
					"response": []
				}
			],
			"description": "Payment processing endpoints using Stripe.\n\n**Payment Flow:**\n1. Create booking ‚Üí Get `bookingId`\n2. Create payment intent ‚Üí Get `clientSecret`\n3. Use `clientSecret` with Stripe.js on frontend\n4. Stripe processes payment\n5. Webhook updates booking status automatically\n\n**Webhook Setup:**\n- Configure in Stripe Dashboard\n- Endpoint URL: `https://your-domain.com/api/v1/payments/stripe/webhook`\n- Required events: `payment_intent.succeeded`, `payment_intent.payment_failed`, `payment_intent.canceled`, `charge.refunded`\n- Webhook secret required for security (signature verification)\n\n**Security:**\n- All payment endpoints verify webhook signatures\n- Only legitimate Stripe events are processed\n- Invalid signatures are rejected"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global pre-request script",
					"if (!pm.environment.get('baseUrl')) {",
					"    pm.environment.set('baseUrl', 'http://localhost:3001');",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global test script",
					"console.log('Response time:', pm.response.responseTime + 'ms');"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:3001",
			"type": "string"
		}
	]
}

